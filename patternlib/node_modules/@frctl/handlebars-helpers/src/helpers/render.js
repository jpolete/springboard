'use strict';

const Handlebars   = require('handlebars');
const defaultsDeep = require('lodash.defaultsdeep');

module.exports = function(fractal){

    return function render(handle){
        let context;
        let source = fractal.components;
        const opts = arguments[arguments.length -1].hash;
        const merge = opts.merge || false;
        if (arguments.length >= 3) {
            context = arguments[1];
        } else if (arguments.length == 2) {
            context = null;
        } else if (arguments.length == 1) {
            fractal.console.error(`[render-helper] You must provide a handle.`);
            return Promise.resolve('');
        }
        const component = source.find(handle);
        if (!component) {
            fractal.console.error(`[render-helper] Component ${handle} not found.`);
            return Promise.resolve('');
        }
        const defaultContext = component.type === 'component' ? component.variants().default().context : component.context;
        if (!context) {
            context = defaultContext;
        } else if (merge) {
            context = defaultsDeep(context, defaultContext);
        }
        return source.render(component, context).then(html => new Handlebars.SafeString(html));
    };

};
